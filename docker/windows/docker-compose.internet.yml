# ============================================
# ONLYOFFICE Document Server - Windows 外网环境配置
# 
# 适用场景:
#   - Windows Server 公网部署
#   - 需要域名访问
#   - 建议启用 HTTPS
#
# 使用方法 (PowerShell):
#   HTTP:  docker-compose -f docker-compose.yml -f docker-compose.internet.yml --profile http up -d
#   HTTPS: docker-compose -f docker-compose.yml -f docker-compose.internet.yml --profile https up -d
# ============================================

version: '3.8'

services:
  onlyoffice:
    # 外网环境不直接暴露端口，通过 Nginx 代理
    # 如需直接访问，取消注释以下配置
    # ports:
    #   - "${ONLYOFFICE_PORT:-8080}:80"
    
    # 外网环境变量
    environment:
      # 外网安全配置
      - ALLOW_PRIVATE_IP_ADDRESS=false
      - ALLOW_META_IP_ADDRESS=false
    
    networks:
      - onlyoffice_network

  # -------------------- Nginx 反向代理（HTTP）--------------------
  
  nginx-http:
    image: nginx:alpine
    container_name: onlyoffice-nginx-http
    restart: unless-stopped
    profiles:
      - http
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
    volumes:
      - ../nginx/nginx.http.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      onlyoffice:
        condition: service_healthy
    networks:
      - onlyoffice_network

  # -------------------- Nginx 反向代理（HTTPS）--------------------
  
  nginx-https:
    image: nginx:alpine
    container_name: onlyoffice-nginx-https
    restart: unless-stopped
    profiles:
      - https
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ../nginx/nginx.https.conf:/etc/nginx/nginx.conf:ro
      - ${SSL_CERT_PATH:-./certs/fullchain.pem}:/etc/nginx/ssl/fullchain.pem:ro
      - ${SSL_KEY_PATH:-./certs/privkey.pem}:/etc/nginx/ssl/privkey.pem:ro
    depends_on:
      onlyoffice:
        condition: service_healthy
    networks:
      - onlyoffice_network

networks:
  onlyoffice_network:
    driver: bridge
